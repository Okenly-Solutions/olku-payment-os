name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build plugin ZIP
        run: |
          chmod +x build.sh
          ./build.sh ${{ steps.get_version.outputs.VERSION }}

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ðŸŽ‰ Olku Payment OS v${{ steps.get_version.outputs.VERSION }}

          ## ðŸ“¦ Installation

          1. Download `olku-payment-os-${{ steps.get_version.outputs.VERSION }}.zip` below
          2. WordPress Admin â†’ Plugins â†’ Add New â†’ Upload Plugin
          3. Upload and activate
          4. Configure in WooCommerce â†’ Settings â†’ Payments

          ## ðŸ“– Documentation

          - ðŸ“˜ [Complete Documentation](https://github.com/${{ github.repository }})
          - ðŸš€ [Quick Start Guide](QUICK_START.md)
          - ðŸ”§ [Installation Guide](INSTALLATION.md)
          - ðŸ‘¨â€ðŸ’» [Developer Guide](EXTENDING.md)

          ## ðŸ“ Changelog

          EOF

          # Append relevant changelog section
          sed -n '/## \['${{ steps.get_version.outputs.VERSION }}'\]/,/## \[/p' CHANGELOG.md | sed '$d' >> release_notes.md

          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/v$(git describe --tags --abbrev=0 HEAD^)...v${{ steps.get_version.outputs.VERSION }}" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Olku Payment OS v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: releases/olku-payment-os-${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZIP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: olku-payment-os-${{ steps.get_version.outputs.VERSION }}
          path: releases/olku-payment-os-${{ steps.get_version.outputs.VERSION }}.zip
          retention-days: 90
